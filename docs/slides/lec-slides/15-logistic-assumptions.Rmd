---
title: "Logistic regression"
subtitle: "Model fit & Assumptions"
author: "Dr. Maria Tackett"
date: "03.18.19"
output:
  xaringan::moon_reader:
    mathjax: "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML"
    css: "sta210-slides.css"
    logo: img/sta210-sticker-icon.png
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE, echo=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
	fig.align = "center",
	fig.height =5,
	fig.width = 8,
	message = FALSE,
	warning = FALSE
)
```


### Announcements

- HW 05 due Mon, Mar 25 at 11:59p



---

### Packages

```{r,echo=T}
library(tidyverse)
library(knitr)
library(broom)
library(NHANES)
library(pROC) #ROC curves
library(questionr)
```

---

### Review

- $Y$: binary response
  + 1: yes
  + 0: no
  
- $Mean(Y) = p$

- $Var(Y) = p(1-p)$

- **Odds of "yes"**: $\omega = \frac{p}{1-p}$

---

### NHANES Data

- [National Health and Nutrition Examination Survey](https://www.cdc.gov/nchs/nhanes/index.htm) is conducted by the National Center for Health Statistics (NCHS) 

- The goal is to *"assess the health and nutritional status of adults and children in the United States"*

- This survey includes an interview and a physical examination

---

### NHANES Data

- We will use the data from the <font class="vocab">`NHANES`</font> R package

- Contains 75 variables for the 2009 - 2010 and 2011 - 2012 sample years

- The data in this package is modified for educational purposes and should **not** be used for research

- Original data can be obtained from the [NCHS website](https://www.cdc.gov/nchs/data_access/index.htm) for research purposes

- Type <font class="vocab">`?NHANES`</font> in console to see list of variables and definitions

---

### NHANES: Physical Activity & Sleep

- Do people who do regular physical activity have lower odds of sleep problems than those who do not do regular physical activity?

- We will analyze the following variables: 
  + <font class="vocab">`PhysActive`: </font>Participant does moderate to vigorous-intensity sports, fitness or recreational activities
  
  + <font class="vocab">`SleepTrouble`: </font>Participant has told doctor or other health professional they had trouble sleeping
  
---

### NHANES: Physical Activity & Sleep

.small[
```{r}
set.seed(1234)
nhanes <- NHANES %>% 
  filter(Age > 18) %>% 
  sample_n(500)
nhanes %>% 
  select(SleepTrouble, PhysActive, Age, CompHrsDay) %>%
  slice(1:5)
```
]

---

### Logistic Regression Model 

- Suppose $P(Y_i=1|X_i) = p_i$ and $P(Y_i=0|X_i) = 1-p_i$

- The <font class="vocab3">logistic regression model </font> is

$$\log\Big(\frac{p_i}{1-p_i}\Big) = \beta_0 + \beta_1 X_i$$
<br> 


- $\log\Big(\frac{p_i}{1-p_i}\Big)$ is called the <font class="vocab3">logit</font> function


---

### Logistic Regression Model 

$$\log\Big(\frac{p_i}{1-p_i}\Big) = \beta_0 + \beta_1 X_i$$
<br> 
<br> 

- We can calculate $p_i$ by solving the logit equation: 

$$p_i = \frac{\exp\{\beta_0 + \beta_1 X_i\}}{1 + \exp\{\beta_0 + \beta_1 X_i\}}$$

---

### Calculating predicted probability, $\hat{p}$ 

$$\begin{aligned}&\log\Big(\frac{p_i}{1-p_i}\Big) = \beta_0 + \beta_1 X_i\\
\Rightarrow \hspace{8mm} &\exp\bigg\{\log\Big(\frac{p_i}{1-p_i}\Big)\bigg\} = \exp\{\beta_0 + \beta_1 X_i\}\\
\Rightarrow \hspace{8mm} & \frac{p_i}{1-p_i} = \exp\{\beta_0 + \beta_1 X_i\} \\
\Rightarrow \hspace{8mm}&p_i = \frac{\exp\{\beta_0 + \beta_1 X_i\}}{1+\exp\{\beta_0 + \beta_1 X_i\}}\\\end{aligned}$$

---

### Interpreting Model Coefficients

$$\log\Big(\frac{p_i}{1-p_i}\Big) = \beta_0 + \beta_1 X_i$$

--

- <font class="vocab">Slope, $\beta_1$: </font>
  + As $X_i$ increases by 1 unit, log-odds of $Y$ increases by $\beta_1$
  + As $X_i$ increases by 1 unit, the odds of $Y$ multiply by a factor of $\exp\{\beta_1\}$

---

 

### Interpreting Model Coefficients

$$\log\Big(\frac{p_i}{1-p_i}\Big) = \beta_0 + \beta_1 X_i$$

--

- <font class="vocab">Intercept, $\beta_0$: </font>
  + When $X=0$, log-odds of $Y$ are $\beta_0$
  + When $X=0$, odds of $Y$ are $\exp\{\beta_0\}$
  + If we mean-center $X$, then we can interpret the intercept in terms of the mean of $X$
--

- Can interpret results by graphing predicted $p$ for values of $X$

---

 

### Estimating the Coefficients

- Estimate coefficients using *maximum likelihood estimation*
  + covered in STA 250 and STA 360
--

- <font class="vocab">Basic Idea: </font>
  + Find values of $\beta_0$ and $\beta_1$ that make observed values of $Y$ the most likely to have occurred
  + Use multivariable calculus and numerical methods to estimate coefficients
--

- We will use R to estimate the coefficients

---

 

### Inference for Coefficients

- <font class="vocab3">standard error, $SE(\hat{\beta}_1)$: </font>estimated standard deviation of the sampling distribution of $\hat{\beta}_1$

- We can calculate the $\color{blue}{100(1-\alpha)\%}$ <font color="blue">confidence interval</font> based on the large-sample Normal approximations
  + **CI for $\boldsymbol{\beta}_1$**: $$\hat{\beta}_1 \pm z^* SE(\beta_1)$$
  + **CI for $\exp\{\boldsymbol{\beta}_1\}$**: $$\exp\{\hat{\beta}_1 \pm z^* SE(\beta_1)\}$$

---

 

### Logistic Regression in R

- Use the <font class="vocab">`glm()`</font> function in R 

- Set <font class="vocab">`family=binomial`</font>

```{r,eval=F}
my.model <- glm(Y ~ X, family=binomial,data=my.data)
```

---

 

### NHANES: Pulse Rate & Sleep

- **Can pulse rate be used to distinguish the odds of an adult having trouble sleeping?**

- <font class="vocab">`Pulse`</font>: 60 second pulse rate


```{r}
#caluclate logistic model using mean-centered Pulse
nhanes <- nhanes %>% mutate(pulse.cent = Pulse - mean(Pulse))
log.odds <- glm(SleepTrouble ~ pulse.cent, family=binomial,data=nhanes)
kable(tidy(log.odds),format="html",digits=3)
```

---

 

### NHANES: Pulse Rate & Sleep
```{r,echo=F}
#caluclate logistic model using mean-centered Pulse
kable(tidy(log.odds),format="html",digits=3)
```

```{r,include=F,echo=F}
interval <- confint_tidy(log.odds)
```


- <font class="vocab">Slope: </font> As pulse rate increases by 1 beat per minute, the odds of having sleep trouble are expected to multiply by a factor of `r round(exp(log.odds$coefficients[2]),2)`, with 95% confidence interval `r round(exp(interval[2,1]),3)` to `r round(exp(interval[2,2]),3)`

--

- <font class="vocab">Intercept: </font> A person with an average pulse (`r round(mean(nhanes$Pulse),3)` beats per minute) is expected to have `r round(exp(log.odds$coefficients[1]),2)` to 1 odds of having sleep trouble, with 95% confidence interval `r round(exp(interval[1,1]),3)` to `r round(exp(interval[1,2]),3)`

---

 

### NHANES: Computers & Sleep

- <font class="vocab">`CompHrsDay`: </font> Number of hours per day on average participant used a computer or gaming device over the last 30 days. 
  + 0_hrs
  + 0_to_1_hr
  + 1_hr
  + 2_hr
  + 3_hr
  + 4_hr
  + More_4_hr
- <font class="vocab">`Age`: </font> Age at time of screening (in years). Participants 80 or older were recorded as 80.

---

 

### NHANES: Computers & Sleep

```{r,echo=F}
#use mean-centered age
nhanes <- nhanes %>% mutate(age.mean = Age - mean(Age))
log.computer <- glm(SleepTrouble ~ CompHrsDay + Age,family=binomial,data=nhanes)
kable(tidy(log.computer),format="html",digits=3)
```


- Describe the relationship between the amount of time spent on a computer and the odds of having trouble sleeping after adjusting for age.

---



### Assumptions & Model Fit

- <font class="vocab">Assumptions</font>
  + Independence of residuals
  + Log-odds has linear relationship with explanatory variables
  + No significant impacts due to influential points or multicollinearity (when there are multiple explanatory variables)
--

- Not effective to examine the residuals
  + Residual positive when $Y=1$ and negative when $Y=0$
  + Constant variance not an assumption of logistic regression
  + Normality of residuals not an assumption of logistic regression

---



### Assumptions & Model Fit

- <font class="vocab">Check Assumptions</font>
  + Plot of binned residuals vs. predicted values
  + Plot of binned residuals vs. numeric explanatory variables
  + Leverage, Cook's distance, and multicollinearity (if more than one explanatory variable)
--

- <font class="vocab">Check Model Fit</font>
  + Examine ROC curve
  + Examine confusion matrix

---



### Binned Residuals

To examine binned residuals...

- Calculate raw residuals
- Order observations either by the values of the predicted probabilities or by the numeric explanatory variable itself
- Use the ordered data to create *g* bins of approximately equal size
  + Default value: $g = \sqrt{n}$
- Calculate average residual value in each bin
- Plot average residuals vs. average predicted probability (or average explanatory variable)

--

Can use the <font class="vocab">`arm`</font> package in R

---



### Binned Residuals

- Look for patterns

- Nonlinear trend may be indication that squared term or log transformation of explanatory variable required

- If bins have average residuals with large magnitude
  + Look at averages of other explanatory variables across bins
  + Interaction may be required if large residuals correspond to certain combinations of explanatory variables
  
---

 

### Raw Residuals: Pulse & Sleep

```{r}
nhanes <- nhanes %>%
  mutate(Residuals = residuals.glm(log.odds,type="response"), 
         Predicted = predict.glm(log.odds,type="response"))
```

```{r,echo=F}
#plot raw residuals vs. predicted
ggplot(data=nhanes, aes(x=Predicted,y=Residuals)) + 
  geom_point() + geom_hline(yintercept=0,color="red")+
  labs(title="Raw Residuals vs. Predicted")+
  theme(plot.title=element_text(hjust=0.5))
```
---

 

### Binned Residuals - Pulse & Sleep
```{r}
library(arm)
binnedplot(x=nhanes$Predicted,y=nhanes$Residuals,xlab="Predicted Probabilities")
```

---

 

### Binned Residuals - Pulse & Sleep

```{r}
library(arm)
binnedplot(x=nhanes$Pulse,y=nhanes$Residuals,xlab="Pulse")
```






