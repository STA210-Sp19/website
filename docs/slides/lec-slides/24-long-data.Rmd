---
title: "Modeling Longitudinal Data"
author: "Dr. Maria Tackett"
date: "04.24.19"
output:
  xaringan::moon_reader:
    mathjax: "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML"
    css: "sta210-slides.css"
    logo: img/sta210-sticker-icon.png
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE, echo=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
	fig.align = "center",
	fig.height = 4,
	fig.width = 7,
	message = FALSE,
	warning = FALSE
)
```


### Announcements

- Regular office hours this week 

- My office hours next week: 
    - Mon, 10a - 11:30a
    - Tues, 1p - 2:30p

- All grades except project by next Monday

- Exam 2 extra credit: If the response rate for the course evaluations is 90%, everyone gets +1 pt on their Exam 2 score (out of 40 pts)

---

### Announcements cont'd

- Project write up due May 1 at 2p

- Project presentations on May 1
    - Lab 01L: 2p - 3:30p
    - Lab 02L: 3:30p - 5p


```{r,echo=F}
library(tidyverse)
library(cowplot)
library(tidyr)
library(knitr)
library(broom)
```

---

## US college completion rates

**What factors most effect completion rates at US colleges?**

<font class="vocab">Response variable: </font>

- **`rate`**: completion rate, i.e. number of degrees awarded per 100 students enrolled

<font class = "vocab">Predictor variables: </font>

- **`year02`**: years since 2002
precipitants (in $1000s)
- **`faculty`**: mean number of full-time faculty in 2002 - 2009
- **`tuition`**: mean yearly tuition between 2002 and 2009

```{r}
college <- read_csv("data/colleges.csv") %>%
  mutate(year02 = year - 2002)
```

```{r echo = F}
college <- college %>%
  select(instname, year02, faculty, tuition, rate)
```

---

## `college` data
 
```{r}
college %>% filter(instname == "Duke University")
```

---

### What makes this model different?

- The goal is to understand what factors of a college number of students per 100 who graduate

- There are multiple observations for each college (so multiple regression not appropriate)

- The are only a few time points in the dataset (so time series model not appropriate)

- We will use a **multilevel model** to model this data


---

## Multilevel Model

Our ultimate goal is to fit a model of the following form that contains two components: 

- **Level One**: include time and any other predictors that can change within a college over the time period 

- **Level Two**: includes predictors that differ between colleges but that remain the same within a college over the time period

---

### Modeling Approach 

**Approach:** Start with simple, preliminary models to establish a baseline that can be used to evaluate larger models. Work toward the final model by adding predictors and checking model assumptions at each step. We can take the following steps:

1. Exploratory data analysis 

2. Fit unconditional means model - model with no predictors

3. Fit unconditional growth model - add time

4. Add predictors


---

## Exploratory Data Analysis

- Given the longitudinal structure of the data, we have observations at different time points for each college in the data set.

- When we do EDA, in addition to an univariate analysis of each variable, we want to look at the following: 
    - **within college**: changes over time within a school
    - **between college**: effects of school-specific predictors (e.g. `faculty`)

---

## Univariate analysis

```{r echo = F, fig.height = 5}
p1 <- ggplot(data = college, aes(x = rate)) +
  geom_histogram() + 
  labs(title = "Rate")

p2 <- ggplot(data = college, aes(x = faculty)) +
  geom_histogram() + 
  labs(title = "Faculty")

p3 <- ggplot(data = college, aes(x = tuition)) +
  geom_histogram() + 
  labs(title = "Tuition")

cowplot::plot_grid(p1,p2,p3, ncol = 2)
```

---

## Rate by Year   

- Let's look at the rate over time for 20 randomly selected colleges

```{r echo = F, fig.height = 5}
set.seed(1234)
names <- college %>% distinct(instname) %>% sample_n(20) %>% pull()
college_samp <- college %>% filter(instname %in% names)

ggplot(data = college_samp, aes(x = year02, y = rate)) +
  geom_point() + 
  geom_line() +
  facet_wrap(~instname)
```

---

## Rate vs. Faculty in 2002

```{r echo = F, fig.height = 5}
college %>% 
  filter(year02 == 0) %>%
  ggplot(aes(x = faculty, y = rate)) +
  geom_point() +
  labs(title = "Faculty vs. Tuition", 
       subtitle = "in 2002")
```

---

## Rate vs. Tuition in 2002

```{r echo = F, fig.height = 5}
college %>% 
  filter(year02 == 0) %>%
  ggplot(aes(x = tuition, y = rate)) +
  geom_point()  +
  labs(title = "Rate vs. Tuition", 
       subtitle = "in 2002")
```

---

## Unconditional Means Model

- In an <font class="vocab">unconditional means model</font>, there are no predictors at any level 

- The goal of this model is to compare variability with colleges and variability between colleges 

.alert[
Let $Y_{ij}$ be the rate of college $i$ in year $j$

$$Y_{ij} = \alpha_0 + u_i + \epsilon_{ij}\\
u_i \sim N(0, \sigma^2_u) \hspace{10mm} \epsilon_{ij} \sim N(0, \sigma^2)$$
]

---

### Rates: Unconditional Means Model

We can fit a multilevel model using the <font class="vocab">`lmer`</font> function in the **lme4** package. 

```{r eval = F}
library(lme4)

model_0 <- lmer(rate ~ 1 + (1|instname), data = college)
summary(model_0)
```

---

### Rates: Unconditional Means Model

```{r echo = F}
library(lme4)
model_0 <- lmer(rate ~ 1 + (1|instname), data = college)
summary(model_0)
```


---

## Understanding the model

- <font class="vocab">Coefficients</font>
    - $\hat{\alpha}_0 = 25.591$: mean completion rate across all colleges

    - $\hat{\sigma}^2_u = 63.35$: variance in the between-college deviations between the college means and the overall mean across all colleges and all years

    - $\hat{\sigma}^2 = 11.18$: variance in within-school deviations between individual rate and college mean across all years
 
--

- <font class="vocab">Intraclass correlation</font>
$$\hat{\rho} = \frac{\hat{\sigma}^2_u}{\hat{\sigma}_u^2 + \hat{\sigma}^2} = \frac{63.35}{63.35 + 11.18} = 0.85$$

About 85% of the total variation in completion rates can be attributed to the difference among schools rather than the change over time within schools.

---

## Unconditional growth model 

- In an <font class="vocab">unconditional growth model</font>, 
there is time added to the Level One model but no predictors in the Level Two model

- The goal of this model is to determine how much of the within-school variability in completion rate can be attributed to changes over time

- We can think of this as building individual models for the change in rate over time for each of the colleges. 
    - We assume the same form of the relationship between `rate` and `year` for every college
    
.alert[
Let $Y_{ij}$ be the `rate` for college $i$ in year $j$

$$Y_{ij} = a_i + b_i \text{year02}_{ij} + \epsilon_{ij}\\
\epsilon_{ij} \sim N(0, \sigma^2)$$
]

---

## Unconditional growth model 

.alert[
Let $Y_{ij}$ be the `rate` for college $i$ in year $j$

$$Y_{ij} = a_i + b_i \text{year02}_{ij} + \epsilon_{ij}\\
\epsilon_{ij} \sim N(0, \sigma^2)$$
]

- $a_i$: expected rate for college $i$ `year02 == 0`, i.e. 2002

- $b_i$: slope for college $i$, i.e. the rate of change in completion rate for college $i$ over the time period

- $\epsilon_{ij}$: deviation in college $i$'s expected and actual completion rate at time $j$
    - $\sigma^2$ is the variability in the deviations
    
---

## UT: Rate over Time

```{r}
college %>%
  filter(instname == "The University of Tennessee") %>%
  ggplot(aes(x = year02, y = rate)) +
           geom_point() + geom_line() + 
           labs(x = "Years Since 2002")
```

---

## Unconditional growth model 

- We will let $a_i$ and $b_i$ vary by college, so we will build Level Two models that incorporate school-level variables to estimate these values 


.alert[
Let $Y_{ij}$ be the `rate` for college $i$ in year $j$

**Level One**

$$Y_{ij} = a_i + b_i \text{year02}_{ij} + \epsilon_{ij}$$


**Level Two**
$$a_i = \alpha_0 + u_i \\
b_i = \beta_0 + v_i$$
]

where $\epsilon_{ij} \sim N(0, \sigma^2)$ and 

$$\bigg[\begin{matrix}u \\ v  \end{matrix}\bigg] \sim N\Bigg(\bigg[\begin{matrix}0 \\ 0 \end{matrix}\bigg], \bigg[\begin{matrix}\sigma^2_u &  \sigma_{vu} \\ \sigma_{uv} & \sigma^2_{v} \end{matrix} \bigg] \Bigg)$$

---

## Unconditional growth model 

- $\sigma^2$: within-school variability 

- $\sigma^2_u$: variability in initial rate

- $\sigma^2_v$: variability in slopes over time

- $\sigma^2_u$ and $\sigma^2_v$ make up the between-school variability 


---

### Rate: Unconditional growth model 

```{r echo = T, eval = F}
library(lme4)
model_1 <- lmer(rate ~ year02 + (year02|instname), data = college)
summary(model_1)
```

---

```{r echo = F, eval = T}
library(lme4)
model_1 <- lmer(rate ~ year02 + (year02|instname), data = college)
summary(model_1)
```

---

## Understanding model 

What do each of the following values tell you?

- $\hat{\alpha}_0 = 25.032$: 

- $\hat{\beta}_0 = 0.153$: 

- $\hat{\sigma}^2 = 7.697$: 

- $\hat{\sigma}^2_u = 62.562$: 

- $\hat{\sigma}^2_v= 0.757$: 

- $\rho_{uv} = -0.19$: 

---

## Add predictors

- Do `faculty` and `tuition` affect completion rates? 

- We will add these predictor variables to the Level Two model, since they differ by college but didn't change within a college (based on how they're defined)

.alert[
Let $Y_{ij}$ be the `rate` for college $i$ in year $j$

**Level One**

$$Y_{ij} = a_i + b_i \text{year02}_{ij} + \epsilon_{ij}$$


**Level Two**
$$a_i = \alpha_0 + \alpha_1 \text{faculty} + \alpha_2 \text{tuition} + u_i \\
b_i = \beta_0 + \beta_1 \text{faculty} + \beta_2 \text{tuition} + v_i$$
]

---

## Add predictors 

```{r echo = T, eval = F}
library(lme4)
model_2 <- lmer(rate ~ year02 + faculty + tuition  +
                  faculty:year02 + tuition:year02 +
                  (year02|instname), data = college)
summary(model_2)
```

---

## Add predictors 

```{r echo = F, eval = T}
model_2 <- lmer(rate ~ year02 + faculty + tuition  +
                  faculty:year02 + tuition:year02 +
                  (year02|instname), data = college)
summary(model_2)
```

---

## References

These notes were based on the chapters ["Introduction to Multilevel Models"](https://bookdown.org/roback/bookdown-bysh/ch-multilevelintro.html) and ["Two Level Longitudinal Data"](https://bookdown.org/roback/bookdown-bysh/ch-lon.html) in *Broadening Your Statistical Horizons*.